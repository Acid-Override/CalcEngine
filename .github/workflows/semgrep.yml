name: Semgrep Security Analysis

on:
  # Run on pushes to main branch
  push:
    branches: [ main ]
  # Run on pull requests targeting main
  pull_request:
    branches: [ main ]
  # Allow manual triggering
  workflow_dispatch:

jobs:
  semgrep:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    permissions:
      # Required for private repos to checkout code
      contents: read
      # Required to upload SARIF results to GitHub Security tab
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Semgrep with custom rules
      uses: semgrep/semgrep-action@v1
      with:
        config: .semgrep.yml
        # Upload results to GitHub Security tab
        publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
        publishDeployment: 1
        generateSarif: "1"
      env:
        # Optional: Set to get more verbose output
        SEMGREP_VERBOSE: "false"
    
    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: semgrep.sarif
      if: always()
        
    # Optional: Fail the build on high severity findings
    - name: Check for high severity findings
      run: |
        if [ -f semgrep.sarif ]; then
          high_findings=$(jq '.runs[0].results | map(select(.level == "error")) | length' semgrep.sarif)
          echo "High severity findings: $high_findings"
          if [ "$high_findings" -gt 0 ]; then
            echo "‚ùå Found $high_findings high severity security issues"
            exit 1
          fi
        fi